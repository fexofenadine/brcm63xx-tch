/* pianod web client - communication class
   Copr. 2013 Perette Barella/Devious Fish
   All rights reserved.
*//* Message number definitions */function PianoConnection(e,t,n){function v(e,t){var n=s[u];delete s[u++],typeof n.handler=="function"&&n.handler(e,t)}function m(e){i&&console.log(e.data);var t=parseInt(e.data.substring(0,3),10),n=e.data.substring(4),s=n.split(": ");s.splice(0,1);var o=s.join(": ");if(t==MSG.DATA_START)p=MSG.STATE_COMMAND,Object.keys(f).length>0&&(a.push(f),f={});else if(t>=MSG.SUCCESS_START&&t<=MSG.SUCCESS_END||t>=MSG.ERROR_START&&t<=MSG.ERROR_END)p==MSG.STATE_COMMAND&&t!=MSG.DATA_END&&console.log("Received ",t," instead of ",MSG.DATA_END),p=r.DISCRETE,Object.keys(f).length>0&&(a.push(f),f={}),v(t,t>=MSG.SUCCESS_START&&t<=MSG.SUCCESS_END?a:n),a=[];if(p==r.DISCRETE){var u=l[t]||[];for(var h=0;h<u.length;h++)u[h](t,n,o);c[t]={code:t,message:n,data:o}}else t>=MSG.INFO_START&&t<=MSG.INFO_END&&(t in f&&(a.push(f),f={}),f[t]=o)}function g(e){for(var t=h.length-1;t>=0;t--)h[t](e)}var r={COMMAND:1,DISCRETE:2},i=0,s={0:{id:0,command:"connect",handler:t||""}},o=1,u=0,a=[],f={},l={},c={},h=[],p=r.DISCRETE,d=new WebSocket(e);return typeof n=="function"&&h.push(n),d.onmessage=function(e){m(e)},d.onopen=function(e){},d.onclose=function(e){g(e)},d.onerror=function(e){g(e)},{request_time_status:function(){d.send(" ")},send_command:function(e,t){typeof e=="object"&&(e='"'+e.join('" "')+'"'),t=t||"";var n={id:o,command:e,handler:t};s[o++]=n,d.send(e)},on_close:function(e){h.push(e)},subscribe:function(e,t,n){typeof e!="object"&&(e=[e]),n=n||!0;for(var r=0;r<e.length;r++){code=e[r],code in l||(l[code]=[]),l[code].push(t),i&&console.log("subscribed ",t," to ",code);if(n&&code in c){var s=c[code];t(s.code,s.message,s.data)}}},is_success:function(e){return e>=MSG.SUCCESS_START&&e<=MSG.SUCCESS_END},is_error:function(e){return e>=MSG.ERROR_START&&e<=MSG.ERROR_END},get_sorted_column:function(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r][t]);return n.sort(function(e,t){var n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0}),n},get_word_flags:function(e,t){var n={},r=t.split(/\s+/);for(var i=0;i<e.length;i++){var s=e[i];n[s]=r.indexOf(s)>=0}return n}}}function execute_command(e,t){viewmanager.execute_command(e,t)}function TrackView(e,t){function v(e){var t=$("#addfromtracktarget");t.html('<option value="">Create new station</option>');for(i=0;i<e.length;i++)t.append($("<option />").text(e[i]))}function m(e){var n=["good","bad","seed","artistseed"],r=t.get_word_flags(n,e);u=r.seed,o=r.artistseed,$("#ratings .bad").toggleClass("selected",r.bad),$("#ratings .good").toggleClass("selected",r.good),$("#ratings .neutral").toggleClass("selected",!r.bad&&!r.good),$("#trackname .button.seed").toggleClass("selected",u),$("#artistname .button.seed").toggleClass("selected",o)}function g(e,t){if(e==MSG.ART)$("#albumart").attr("src",t===""?"no-art.jpeg":t);else if(e==MSG.ID)s=t;else if(e==MSG.RATING)m(t);else if(e==MSG.URL)$("#additionalinfo").attr("href",t);else{var r=n[e];$("#"+r+" .value").text(t)}}function y(){var e=r===0;e&&!c&&$("#albumart").attr("src","no-art.jpeg"),$("#trackdetails").css("visibility",c||!e?"visible":"hidden"),$("#controller").css("visibility",c||!e?"visible":"hidden"),$("#statusbar").css("visibility",e&&c?"visible":"hidden"),$("#controller .time").css("visibility",c?"visible":"hidden"),$("#networkstatus").css("visibility",e&&c&&h?"visible":"hidden"),$("#pausestatus").css("visibility",e&&c&&p?"visible":"hidden"),$("#stoppedstatus").css("visibility",e&&!c&&d?"visible":"hidden")}function b(){$("#nowplaying").toggle(r!==0),$("#stationname").toggle(r===0),y()}function w(){var e=new Date,t=Math.round((e.getTime()-a)/1e3),n=Math.floor(t/60),r=t%60;$("#timepoint").text(n+":"+(r<=9?"0":"")+r);if(f>0){var i=Math.round(t*100/f);$("#progressbar").css("width",i+"%")}}function E(e,t){var n=new Date,r=t.split(" ")[0].split("/");$("#duration").text(r[1]);var i=r[0].split(":"),s=r[1].split(":"),o=parseInt(i[0],10)*60+parseInt(i[1],10);f=parseInt(s[0],10)*60+parseInt(s[1],10),a=n.getTime()-o*1e3,w()}function S(e,t){c=e==MSG.PLAYING||e==MSG.PAUSED||e==MSG.STALLED,h=e==MSG.STALLED,p=e==MSG.PAUSED,y(),e!=MSG.TRACKCOMPLETE&&$("#playpause").html(e==MSG.PAUSED||e==MSG.STOPPED?"▶":"&nbsp;||&nbsp;"),e==MSG.PLAYING?typeof l=="undefined"&&(l=setInterval(w,1e3)):typeof l!="undefined"&&(clearInterval(l),l=undefined)}function x(n){t.send_command(["queue",n],function(i,o){e.report_status(i,o);if(t.is_success(i))if(o.length!=1)console.log("Received ",o.length," records with QUEUE # command");else{r=n,b();for(var u in o[0])g(u,o[0][u])}else i==MSG.WRONG_STATE?(e.success("There is nothing playing right now."),s=undefined,r=0,b()):e.error(o)})}var n={112:"albumname",113:"artistname",114:"trackname",115:"songstation"},r=0,s,o=!1,u=!1,a=0,f=0,l=undefined,c=!1,h=!1,p=!1,d=!1;return b(),t.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STOPPED,MSG.STALLED,MSG.TRACKCOMPLETE],S,!1),t.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STALLED],E,!1),t.subscribe(MSG.TRACKCOMPLETE,function(e){r!==0?(r--,b()):s==undefined},!1),t.subscribe(MSG.NOSTATION,function(e,t,n){$("#stationname").html("&nbsp;"),d=!0},!1),t.subscribe(MSG.SELECTEDSTATION,function(e,t,n){var r=n.split(/\s+/).slice(1);$("#stationname").text(r.join(" ")),d=!1},!1),t.subscribe([MSG.ALBUM,MSG.ARTIST,MSG.SONG,MSG.ART,MSG.RATING,MSG.STATION,MSG.ID,MSG.URL],function(e,t,n){r===0&&(g(e,n),e==MSG.URL&&(c=!0,$("#trackdetails").css("visibility","visible")))}),t.subscribe([MSG.VOLUME],function(e,t,n){$("#volume").val(n)}),e.get_view("station").subscribe_to_stations(v),t.request_time_status(),t.send_command("status"),{destroy:function(){typeof l!="undefined"&&clearInterval(l)},go_to_history_index:function(e){x(e)},go_to_previous_track:function(){x(r-1)},go_to_next_track:function(){x(r+1)},go_to_current_track:function(){x(0)},play_pause:function(){t.send_command(["playpause"],function(t,n){t==MSG.WRONG_STATE?(e.show("station"),e.error("Please choose a station.")):e.report_status(t,n)})},rate_track:function(n){typeof s=="undefined"?e.error("No track selected."):t.send_command(["rate",n,s],function(i,s){e.report_status(i,s),t.is_success(i)&&n=="overplayed"&&e.success("Song will not be played again for a month."),t.is_success(i)&&r!==0&&x(r)})},toggle_seed:function(n){var i;(n=="artist"?o:u)?i=["DELETE",n,"SEED",s]:i=["ADD",n,"SEED","FROM","SONG",s],t.send_command(i,function(n,i){e.report_status(n,i),t.is_success(n)&&x(r)})},set_volume:function(){var e=$("#volume").val();t.send_command(["volume",e])},show_seeds:function(){var t=$("#songstation .value").text();$("#revisestation").val(t),e.show("seed"),e.get_view("seed").select_station()},showart:function(){var t=$("#albumart").attr("src");t===""?e.error("There is no art available."):$("<img/>").attr("src",t).load(function(){window.open(t,"_blank","status=0,menubar=0,scrollbars=0,resizable=0,location=0,toolbar=0,width="+this.width+",height="+this.height)}).error(function(){e.error("Error zooming album art.")})},explain_song:function(){t.send_command(["explain","song",s],function(n,r){e.report_status(n,r),t.is_success(n)&&alert(r[0][MSG.EXPLANATION])})},add_from_track:function(t){var n=$("#addfromtracktarget").prop("selectedIndex");if(n>0){var r=$("#addfromtracktarget").val();e.execute_command(["ADD",t,"SEED","TO",r,"FROM","SONG",s],"Added "+t+"seed to "+r+".")}else{var r=$("#addstationfromtrackname").val();r===""?e.error("Please provide a station name."):e.execute_command(["CREATE","STATION","NAMED",r,"FROM",t,s],"Created "+r+".")}$("#addstationfromtrack").hide()},select_add_target:function(){var e=$("#addfromtracktarget").prop("selectedIndex");$("#addstationfromtrackname").toggle(e===0),$("#doaddseedfromsong").text(e===0?"Add station from song":"Add seed from song"),$("#doaddseedfromartist").text(e===0?"Add station from artist":"Add seed from artist")}}}MSG={WELCOME:100,PLAYING:101,PAUSED:102,STOPPED:103,INTERTRACK:104,TRACKCOMPLETE:105,STALLED:106,NOSTATION:108,SELECTEDSTATION:109,ID:111,ALBUM:112,ARTIST:113,SONG:114,STATION:115,RATING:116,URL:117,ART:118,GENRE:119,MYRATING:120,EXPLANATION:121,YELL:131,ACTIVITY:132,NEWS:133,MIX_CHANGED:134,STATIONS_CHANGED:135,PRIVILEGES:136,USERRATINGS_CHANGED:137,VOLUME:141,INFO_START:100,INFO_END:199,SUCCESS_START:200,SUCCESS_END:299,DATA_START:203,DATA_END:204,DETAIL_START:300,DETAIL_END:399,ERROR_START:400,WRONG_STATE:405,ERROR_END:499,FAILURE_START:500,FAILURE_END:599},ViewManager=function(){function add_view(e,t){views[e]=t}function update_view(){var e=VIEWS[viewname],t=$(window).innerWidth(),n=$(window).innerHeight(),r=$("#status").css("font-size"),i=Math.round(parseInt(r.replace("px",""),10)*1.3),s=Math.floor(n/i),o=Math.floor(t/250),u=adaptive?Math.floor((t-o*250)/o):0,a=o;s-=a<=1?5:4,s<0&&(s=1),$("#views > div > div").hide(),$("#views").css("min-height",Math.floor(s*i)+"px");for(var f=0;f<e.length&&a>0;f++){var l=e[f],c="get_width"in views[l]?views[l].get_width(s,a,o>1):1;if(c===0)continue;c>4&&(c=4);var h=c>a?a:c;"set_width"in views[l]&&views[l].set_width(h),$("#"+e[f]+"view").show().attr("class","columns-"+h).css("width",(240+u)*h).find(".columnar").css(".columns",220+u+" auto"),a-=h}$("#albumart").css("width",230+u+"px"),$("#controller").css("left",10+Math.floor(u/2)+"px")}function setup_accordions(){$(".accordion > div").hide();var accordions=$(".accordion h3");for(var i=0;i<accordions.length;i++)$(accordions[i]).click(function(trigger){accordion=$(trigger.target);var closing=accordion.hasClass("selected");accordion.parent().find("h3").removeClass("selected"),accordion.parent().find("div").hide();if(!closing){var id=accordion.attr("id"),viewname="";if(typeof id!="undefined"){var view=accordion;while(view!=window){view=view.parent();var name=view.attr("id");if(typeof name!="undefined"){if(name=="views"){eval(viewname+".open_"+id+"();");break}viewname=name}}}accordion.addClass("selected"),accordion.next().show()}})}function privilege_change(e,t,n){var r=piano.get_word_flags(["disabled","guest","listener","admin","user","owner","service","influence","tuner"],n);$(".privadmin").toggleClass("disabled",!r.admin),$("input.privadmin").prop("disabled",!r.admin),$(".privowner").toggleClass("disabled",!r.owner),$("input.privowner").prop("disabled",!r.owner),$(".privuser").toggleClass("disabled",!r.admin&&!r.user),$("input.privuser").prop("disabled",!r.admin&&!r.user),$(".privservice").toggleClass("disabled",!r.service),$(".privinfluence").toggleClass("disabled",!r.influence)}function record_protocol_version(e,t){var n=t.split(".");protocol_version=0;if(n.length>=2){var r=n[0].split(/\s+/);if(r.length>=2&&r[0]=="pianod"){protocol_version=parseInt(r[1],10);for(var i=154;i<=200;i++)$(".protoend"+i).toggle(protocol_version<i),$(".proto"+i).toggle(protocol_version>=i)}else alert("Service identifies itself as "+(r.length>=2?r[0]:"(unidentified)")+", not pianod.")}}function create_subscriptions(){privilege_change(undefined,undefined,"disabled"),piano.subscribe(MSG.WELCOME,record_protocol_version),piano.subscribe(MSG.PRIVILEGES,privilege_change)}function parse_query_strings(){var e={},t=window.location.toString().split("?");if(t.length>1){var n=t[1].split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");e[i[0]]=i[1]}}return e}VIEWS={login:["login"],track:["track","station","activity","admin"],station:["station","track","seed","activity","admin"],activity:["activity","track","user","station"],admin:["admin","track","activity","user","station"],seed:["seed","track","station","activity","station"],user:["user","track","admin","activity","station"]};var piano,viewname,views={},protocol_version=0,adaptive=!0;window.onresize=function(){update_view()},setup_accordions();var public_interface={reset:function(){$(".accordion > div").hide(),$(".accordion").parent().find("h3").removeClass("selected"),$("input[type=text]").val(""),$("input[type=url]").val(""),$("input[type=password]").val(""),$("textarea").val(""),$("select").prop("selectedIndex",0)},show:function(e){viewname=e,update_view()},get_view:function(e){return views[e]},success:function(e){$("#status").removeClass("error"),$("#status .value").text(e)},error:function(e){$("#status").addClass("error"),$("#status .value").text(e)},clear:function(){$("#status").removeClass("error"),$("#status .value").html("&nbsp;")},report_status:function(e,t){piano.is_success(e)?viewmanager.clear():viewmanager.error(t)},init:function(){var e=parse_query_strings();"size"in e&&(adaptive=e["size"]!="fixed"),loginview=new LoginView(public_interface,e),add_view("login",loginview),loginview.show()},start_session:function(e){piano=e,create_subscriptions(),activityview=new ActivityView(public_interface,piano),add_view("activity",activityview),stationview=new StationView(public_interface,piano),add_view("station",stationview),trackview=new TrackView(public_interface,piano),add_view("track",trackview),adminview=new AdminView(public_interface,piano),add_view("admin",adminview),seedview=new SeedView(public_interface,piano),add_view("seed",seedview),userview=new UserView(public_interface,piano),add_view("user",userview),$("#switcher").show()},terminate_session:function(){for(var e in views)e!="login"&&("destroy"in views[e]&&views[e].destroy(),delete views[e]);userview=undefined,seedview=undefined,adminview=undefined,stationview=undefined,trackview=undefined,activityview=undefined,pianod=undefined,$("#switcher").hide()},execute_command:function(e,t){piano.send_command(e,function(e,n){piano.is_success(e)?typeof t=="undefined"?viewmanager.clear():viewmanager.success(t):viewmanager.error(n)})},close_accordion:function(e){var t=$("#"+e+" .accordion");t.each(function(e,t){$(t).find("h3").removeClass("selected"),$(t).find("div").hide()})},logout:function(){piano.send_command("QUIT")},protocol:function(){return protocol_version}};return public_interface},ActivityView=function(e,t){function a(){var e=Math.floor(s/r),t=Math.ceil(o.length/e);u>=t&&(u=t-1),u<0&&(u=0),$("#activitypages").text(t),$("#activitypage").text(u+1);var n=o.length-e*u-1;if(o.length>0){var i=$("#recentactivity");i.text("");for(var a=0;a<e;a++)if(n>=0){var f=document.createElement("li");$(f).text(o[n--]),i.append(f)}}}var n=200,r=2,i=6,s=18,o=[],u=0;return t.subscribe([MSG.WELCOME,MSG.YELL,MSG.NEWS,MSG.ACTIVITY],function(e,t){o.push(t),o.length>n&&(o=o.slice(1)),u===0&&a()}),t.send_command(["USERS","ONLINE"],function(e,n){t.is_success(e)?(n=t.get_sorted_column(n,MSG.ID),o=n.reverse().concat(["Listeners online:"],o)):o.push("Activity messages are disabled."),a()}),{get_width:function(e){return e-=i,s=e>0?e:1,1},set_width:function(e){a()},show_now:function(){u=0,a()},previous:function(){u--,a()},next:function(){u++,a()},yell:function(){var t=$("#yellmessage").val().replace(/\n/g,"  ");t.match(/^\s*$/)?e.error("No message to yell."):e.execute_command(["YELL",t])}}},AdminView=function(e,t){function n(){var e=localStorage.pandorauser||"",t=localStorage.pandorapassword||"",n=localStorage.pandoraowner||"";$("#pandorauser").val(e),$("#pandorapassword").val(t),$("#storepandorapassword").prop("checked",t!==""),n!==""&&$("#pandoraownertype").val(n)}function r(t){var n=e.get_view("login").get_username(),r=$("#ownerselector");r.text("");for(var i=0;i<t.length;i++){var s=document.createElement("option");$(s).text(t[i]),t[i]==n&&$(s).prop("selected",!0),r.append(s)}}return n(),{pandora_user:function(){var t=$("#pandorauser").val(),n=$("#pandorapassword").val(),r=$("#pandoraownertype").val();if(t===""||n==="")e.error("Please provide your username and password.");else{var i=["PANDORA","USER",t,n];localStorage.pandorauser=t,localStorage.pandoraowner=r,$("#storepandorapassword").is(":checked")&&i.splice(0,0,"REMEMBER"),r!="admin"&&i.push(r),e.execute_command(i,"Change takes full effect after current track; music will stop.")}},open_use_existing_pandora:function(){e.protocol()<154?alert("Can not use existing Pandora for this version."):e.protocol()==154?r([e.get_view("login").get_username()]):t.send_command(["PANDORA","LIST","USERS"],function(n,i){e.report_status(n,i),t.is_success(n)&&r(t.get_sorted_column(i,MSG.ID))})},select_owner:function(){var t=$("#ownerselector").val();e.execute_command(["pandora","use",t])}}},LoginView=function(e,t){function v(t,o){u.is_success(t)?(e.clear(),l&&(localStorage.username=n,localStorage.server=i,localStorage.secure=s?"Secure":"",$("#storepassword").is(":checked")?localStorage.password=r:localStorage.removeItem("password")),a=STATE.CONNECTED,e.start_session(u),e.show("track")):(e.error("Login failed: "+o),u.send_command("QUIT"))}function m(){a=STATE.AUTHORIZING,n===""?v(200,"Login successful"):u.send_command(["USER",n,r],v)}function g(){e.get_view("login").show(),e.terminate_session(),a==STATE.DISCONNECTED&&i.indexOf(":")<0?e.error("Connection failed.  Check port number."):e.error(a==STATE.DISCONNECTED?"Connection failed":a==STATE.AUTHORIZING?"Bad user credentials":"Session ended."),a=STATE.DISCONNECTED}STATE={CONNECTED:0,AUTHORIZING:1,DISCONNECTED:2};var n=localStorage.username||"",r=localStorage.password||"",i=localStorage.server||"house.perette.barella.org:4446",s=(localStorage.secure||"")=="Secure",o=!1,u,a=STATE.DISCONNECTED,f=!1,l=!0,c=!0,h,p=window.location.toString().split("?");if(p.length>=1){var d=p[0].split("/");d.length>3&&(h=d[2].toLowerCase(),c=h.match("deviousfish.com")||d[0]!="http:"&&d[0]!="https:",o=d[0]=="https:")}c||$("#serverinput").hide(),"server"in t&&(i=t.server);if("login"in t){var y=t.login;y=="visitor"?(f=!0,l=!1):y=="auto"?f=!0:y=="login"?f=n!=="":(f=y==n&&n!=="",n===""&&(n=y))}return{show:function(){e.show("login"),e.reset(),$("#username").val(n),$("#password").val(r),$("#storepassword").prop("checked",r!==""),$("#server").val(i),$("#secureserver").prop("checked",s),f&&(this.connect(!l),f=!1)},connect:function(t){i=$("#server").val(),s=$("#secureserver").is(":checked");var a=o||s,f=(a?"wss://":"ws://")+(c?i:h)+"/pianod?encoding=text";n=t?"":$("#username").val(),r=t?"":$("#password").val(),l=!t,e.success("Opening connection to "+f),u=new PianoConnection(f,m,g),typeof u=="undefined"&&e.error(i+": Connection failed")},get_username:function(){return n},toggle_security:function(){var e=$("#secureserver").is(":checked"),t=$("#server").val(),n=t.split(":");n.length==2&&e&&n[1]=="4446"?$("#server").val(n[0]+":4447"):n.length==2&&!e&&n[1]==4447&&$("#server").val(n[0]+":4446")}}},SeedView=function(e,t){function f(e,t,r,i){var s=$(e+" thead"),o=$("<tr />");for(var u=0;u<r.length;u++){var f=n[r[u]],l=$("<th />").text(f);i&&(l.attr("onclick",'seedview.set_seed_sort ("'+f+'");'),f==a&&l.text(f+"▾")),o.append(l)}s.html(o);var h=$(e+" tbody");h.text("");for(u=0;u<t.length;u++){var p=$("<tr />");for(c=0;c<r.length;c++){var d="";typeof r[c]=="function"?d=r[c](t[u]):r[c]in t[u]&&(d=$("<span />").text(t[u][r[c]])),p.append($("<td />").append(d))}h.append(p)}}function l(e,t,n){return n in e||n in t?n in e?n in t?e[n]<t[n]?-1:e[n]>t[n]?1:0:-1:1:0}function h(e,t){return l(e,t,MSG.GENRE)||l(e,t,MSG.STATION)||l(e,t,MSG.ARTIST)||l(e,t,MSG.SONG)}function p(e,t){return l(e,t,MSG.ARTIST)||l(e,t,MSG.SONG)}function d(e,t){return l(e,t,MSG.SONG)||l(e,t,MSG.ARTIST)}function v(e,t){return l(e,t,MSG.GENRE)||l(e,t,MSG.STATION)}function m(n){var r=$("#suggestionsearch").val(),i=$("#suggestiontype").val();if(r==="")e.error("Please enter a search query.");else{var s=["FIND",i];n||s.push(r),t.send_command(s,function(n,r){var s=[MSG.ARTIST,MSG.SONG,MSG.GENRE,MSG.STATION],o=h;switch(i){case"Song":s=[MSG.ARTIST,MSG.SONG],o=d;break;case"Artist":s=[MSG.ARTIST],o=p;break;case"Genre":s=[MSG.GENRE,MSG.STATION],o=v}s.push(function(e){return $("<a />").text("+Add").addClass("add").attr("onclick",'seedview.add_seed ("'+e[MSG.ID]+'", "'+(e[MSG.SONG]||e[MSG.ARTIST]||e[MSG.STATION]||"").replace(/"/,"")+'");')}),r.sort(o),t.is_success(n)?f("#seedsuggestions",r,s,!1):e.error(r)})}}function g(e,t){switch(a){case"Type":return l(e,t,MSG.RATING)||l(e,t,MSG.ARTIST)||l(e,t,MSG.SONG);case"Artist":return l(e,t,MSG.ARTIST)||l(e,t,MSG.SONG)}return l(e,t,MSG.SONG)||l(e,t,MSG.ARTIST)}function y(){var n=$("#revisestation").val();n===""?e.error("Please select a station."):t.send_command(["STATION","SEEDS",n],function(n,r){t.is_success(n)?(r.sort(g),f("#seedsexisting",r,[MSG.ARTIST,MSG.SONG,MSG.RATING,function(e){return $("<a />").html("✖Remove").addClass("remove").attr("onclick",'seedview.delete_seed ("'+e[MSG.ID]+'", "'+(e[MSG.SONG]||e[MSG.ARTIST]||e[MSG.STATION]||"").replace(/"/,"")+'");')}],!0)):e.error(r)})}function b(e){var t=$("#revisestation");t.html('<option value="">Create new station</option>');for(i=0;i<e.length;i++)t.append($("<option />").text(e[i]))}var n={113:"Artist",114:"Title",119:"Genre",116:"Type",115:"Station"};reserved_lines=4;var r=13,s=!1,o=[],u=[],a="Artist";return e.get_view("station").subscribe_to_stations(b),{get_width:function(e,t,n){return t<=1&&n?0:(e-=reserved_lines,e<5&&(e=5),$("#seedview h3+div").css("height",e+"em"),3)},set_width:function(e){s=e==1,r=s?3:13},select_station:function(e){y()},open_add_seeds:function(){},open_revise_seeds:function(){y()},delete_seed:function(t,n){confirm("Are you sure you want to remove the seed for "+n+"?")&&(e.execute_command(["DELETE","SEED",t],"Seed removed."),y())},reperform_search:function(){m(!0)},perform_search:function(){m(!1)},add_seed:function(t,n){var r=$("#revisestation").val();r===""?(r=prompt("Please enter a name for this new station:"),r!==null&&(r===""?e.error("You must assign a name for a new station."):e.execute_command(["CREATE","STATION","NAMED",r,"FROM","SUGGESTION",t],"Created "+r+"."))):e.execute_command(["ADD","SEED","FROM","SUGGESTION",t,"TO",r],"Added "+n+" to "+r+".")},set_seed_sort:function(e){a=e,y()},remove_station:function(){var t=$("#revisestation").val();t===""?e.error("Please select a station."):confirm("Are you sure you want to remove "+t+"?")&&e.execute_command(["DELETE","STATION",t])}}},StationView=function(e,t){function v(){var e=typeof i=="undefined"?a.length:Math.floor(i/s),t=e*u,n=Math.ceil(a.length/t);l>=n&&(l=n-1),l<0&&(l=0),$("#stationpages").text(n),$("#stationpage").text(l+1);var o=l*t,f=$("#stationlist");f.text("");for(var c=0;c<t;c++){var h=document.createElement("li");f.append(h);if(o<a.length){for(var p in r){var d=document.createElement("a");$(d).attr("onclick","stationview.rate_station ("+o+', "'+p+'");').text(r[p].icon).addClass("button").attr("title",r[p].tip).toggleClass("selected",a[o].rating==p),$(h).append(d)}var v=document.createElement("input");$(v).prop("checked",a[o].mix).attr("type","checkbox").attr("onclick","stationview.toggle_station ("+o+")").attr("id","stationmix"+o),$(h).append(v);var m=document.createElement("label");$(m).text(a[o].name).attr("onclick","stationview.select_station ("+o+")").attr("for","stationmix"+o),$(h).append(m),o++}else $(h).html("&nbsp;")}}function m(n,r){if(t.is_success(n)){var i=t.get_sorted_column(r,MSG.STATION);a=[];for(s=0;s<i.length;s++)a.push({name:i[s],mix:!1,rating:"neutral"});v();for(var s=0;s<f.length;s++)f[s](i)}else e.error(r)}function g(n,r){if(t.is_success(n)){for(var i=0;i<a.length;i++)a[i].mix=!1;for(var s=0;s<r.length;s++){var o=r[s][MSG.STATION];for(i=0;i<a.length;i++)o==a[i].name&&(a[i].mix=!0)}}else e.error(r);v()}function y(n,r){if(t.is_success(n))for(var i=0;i<r.length;i++){var s=r[i][MSG.STATION],o=r[i][MSG.MYRATING];for(var u=0;u<a.length;u++)s==a[u].name&&(a[u].rating=o)}else e.error(r);v()}function b(e){e==MSG.STATIONS_CHANGED&&t.send_command(["STATIONS","LIST"],m),(e==MSG.STATIONS_CHANGED||e==MSG.MIX_CHANGED)&&t.send_command(["MIX","LIST","INCLUDED"],g),(e==MSG.STATIONS_CHANGED||e==MSG.USERRATINGS_CHANGED)&&t.send_command(["STATION","RATINGS"],y)}function w(){$("#selectmode").toggle(h!=c&&(h=="auto"||h=="mix")),$("#stationlist").toggleClass("showmix",h=="mix"),$("#stationlist").toggleClass("showratings",h=="auto"),$("#showmode").toggleClass("selected",c==h),$("#showmode").toggleClass("pending",c!=h);var e=h=="auto"?1.5:1;e!=s&&(s=e,v())}var n=3,r={bad:{icon:"☠",tip:"Hate this station."},neutral:{icon:"☯",tip:"Neither love nor hate this station."},good:{icon:"♥",tip:"Love this station."}},i,s=1,o=15,u=1,a=[],f=[],l=0,c="",h="station",p=!1,d=!1;return t.subscribe(MSG.STATIONS_CHANGED,b),t.subscribe(MSG.MIX_CHANGED,b),t.subscribe(MSG.USERRATINGS_CHANGED,b),t.subscribe(MSG.SELECTEDSTATION,function(e,t,n){var r=n.split(/\s+/),i=r[0];if(h==c||c==="")h=i,$("#showmode").val(i);c=i,w()},!1),t.subscribe(MSG.NOSTATION,function(){c="",w()},!1),b(MSG.STATIONS_CHANGED),t.send_command("STATUS",function(){}),{get_width:function(e,t,r){if(!r)return i=undefined,1;e-=n,i=e>0?e:1;var o=Math.floor(i/s),u=Math.ceil(a.length/o);return u<1?1:u},set_width:function(e){u=e,v()},previous:function(){l--,v()},next:function(){l++,v()},select_station:function(t){h=="station"&&(e.execute_command(["PLAY","STATION",a[t].name]),e.show("track"))},toggle_station:function(t){h=="mix"&&e.execute_command(["MIX","TOGGLE",a[t].name])},rate_station:function(t,n){e.execute_command(["RATE","STATION",n,a[t].name])},change_shown_mode:function(){h=$("#showmode").val(),w()},select_mode:function(){e.execute_command(["PLAY",h]),e.show("track")},subscribe_to_stations:function(e){f.push(e),e(a)}}},UserView=function(e,t){function n(t,n){var r=$(t).val(),i=$(n).val();return r==i?r:(e.error("New passwords do not match."),undefined)}return{change_password:function(){var t=$("#oldpassword").val(),r=n("#newpassword","#confirmpassword");typeof r!="undefined"&&e.execute_command(["SET","PASSWORD",t,r],"Password successfully updated.")},create_user:function(){var t=$("#createusername").val(),r=$("#createusertype").val(),i=n("#createpassword","#createconfirmpassword");typeof i!="undefined"&&e.execute_command(["CREATE",r,t,i],"User "+t+" successfully added.")},open_alter_user:function(){t.send_command(["USERS","LIST"],function(n,r){if(t.is_success(n)){var i=t.get_sorted_column(r,MSG.ID),s=$("#alterusername");s.html('<option value="">Select user</option>');for(var o=0;o<i.length;o++)s.append($("<option />").text(i[o]).attr("value",i[o]))}else e.error("Can not update user list")})},select_alter_user:function(){var e=$("#alterusername").val();e!==""&&t.send_command(["USERS","LIST",e],function(e,n){if(t.is_success(e)&&n.length==1){var r=n[0][MSG.PRIVILEGES],i=r.split(/ +/);$("#alterusertype").val(i[0]),all_privileges=["influence","service"];var s=t.get_word_flags(all_privileges,r);for(var o=0;o<all_privileges.length;o++){var u=all_privileges[o];$("#privilege"+u).prop("checked",s[u])}}})},change_type:function(){var t=$("#alterusername").val(),n=$("#alterusertype").val();t===""?e.error("Please select a user to change their type."):e.execute_command(["SET","USER","LEVEL",t,n],"User "+t+" updated.")},change_privilege:function(t){var n=$("#alterusername").val(),r=$("#privilege"+t).prop("checked");n===""?e.error("Please select a user to change their type."):e.execute_command([r?"GRANT":"REVOKE",t,r?"TO":"FROM",n],"User "+n+" updated.")},reset_password:function(){var t=$("#alterusername").val();if(t==="")e.error("Please select a user to reset.");else{var n=confirm("This will clear "+t+"'s password\n"+"so they can login without a password.\n"+"This is insecure.  Are you sure?");n&&e.execute_command(["SET","USER","PASSWORD",t,""],"Password reset for "+t+".")}},delete_user:function(){var t=$("#alterusername").val();if(t==="")e.error("Please select a user to delete.");else{var n=confirm("Are you sure you want to delete "+t+"?");n&&(e.execute_command(["DELETE","USER",t],"User "+t+" removed."),this.open_alter_user())}},open_kick_user:function(){t.send_command(["USERS","ONLINE"],function(n,r){if(t.is_success(n)){var i,s;$("#onlineusers").text("");for(var o=0;o<r.length;o++){var u=r[o][MSG.ID];i=$("<a />").text("╳").addClass("remove").click(function(){e.execute_command(["KICK","USER",u]),userview.open_kick_user()}),s=$("<li />").append(i).append($("<span />").text(" "+u)),$("#onlineusers").append(s)}i=$("<a />").text("╳").addClass("remove").click(function(){e.execute_command(["KICK","VISITORS"]),userview.open_kick_user()}),s=$("<li />").append(i).append($("<span />").text(" All Visitors")),$("#onlineusers").append(s)}else e.error("Can not retrieve online user list.")})}}};